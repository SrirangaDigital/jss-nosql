<?php

class data extends Controller {

	public function __construct() {
		
		parent::__construct();
	}

	public function buildDBFromJson() {

		$this->insertForeignKeys();

		$jsonFiles = $this->model->getFilesIteratively(PHY_METADATA_URL, $pattern = '/index.json$/i');
		
		$db = $this->model->db->useDB();
		$collection = $this->model->db->createCollection($db, ARTEFACT_COLLECTION);

		$foreignKeys = $this->model->getForeignKeyTypes($db);

		foreach ($jsonFiles as $jsonFile) {

			$content = $this->model->getArtefactFromJsonPath($jsonFile);
			$content = $this->model->insertForeignKeyDetails($db, $content, $foreignKeys);
			$content = $this->model->insertDataExistsFlag($content);
			$content = $this->model->beforeDbUpdate($content);

			$result = $collection->insertOne($content);
		}
	}
	
	private function insertForeignKeys()
	{
		$jsonFiles = $this->model->getFilesIteratively(PHY_FOREIGN_KEYS_URL, $pattern = '/.json$/i');
		
		$db = $this->model->db->useDB();
		$collection = $this->model->db->createCollection($db, FOREIGN_KEY_COLLECTION);

		foreach ($jsonFiles as $jsonFile) {

			$contentString = file_get_contents($jsonFile);
			$content = json_decode($contentString, true);
			$content = $this->model->beforeDbUpdate($content);

			$result = $collection->insertOne($content);
		}
	}

	// Use this method for global changes in json files
	public function modify() {

		$jsonFiles = $this->model->getFilesIteratively(PHY_METADATA_URL . '001/' , $pattern = '/index.json$/i');
		
		foreach ($jsonFiles as $jsonFile) {

			$contentString = file_get_contents($jsonFile);
			$content = json_decode($contentString, true);

			$id = $content['id'];

			preg_match('/.*\/(.*)\.(.*)\/.*/', $id, $matches);

			$lookup = ["001.001" => "A", "001.002" => "A", "001.003" => "A", "001.004" => "A", "001.005" => "A", "001.006" => "A", "001.007" => "B", "001.008" => "B", "001.009" => "B", "001.010" => "B", "001.011" => "B", "002.001" => "A", "002.002" => "A", "002.003" => "A", "002.004" => "A", "002.005" => "A", "002.006" => "A", "002.007" => "A", "002.008" => "A", "002.009" => "A", "002.010" => "A", "002.011" => "A", "002.012" => "A", "002.013" => "A", "003.001" => "A", "003.002" => "A", "003.003" => "A", "003.004" => "A", "004.001" => "A", "004.002" => "A", "004.003" => "A", "004.004" => "A", "004.005" => "B", "004.006" => "B", "004.007" => "B", "004.008" => "C", "004.009" => "C", "004.010" => "C", "004.011" => "C", "004.012" => "D", "004.013" => "D", "004.014" => "D", "004.015" => "D", "004.016" => "D", "004.017" => "E", "004.018" => "E", "004.019" => "E", "004.020" => "E", "004.021" => "F", "004.022" => "F", "004.023" => "F", "004.024" => "G", "004.025" => "G", "004.026" => "G", "004.027" => "H", "004.028" => "H", "004.029" => "H", "004.030" => "H", "004.031" => "H", "004.032" => "H", "004.033" => "I", "004.034" => "I", "004.035" => "I", "004.036" => "I", "004.037" => "I", "004.038" => "I", "004.039" => "J", "004.040" => "J", "004.041" => "J", "004.042" => "J", "004.043" => "J", "005.001" => "A", "005.002" => "A", "005.003" => "A", "005.004" => "A", "005.005" => "A", "005.006" => "A", "005.007" => "A", "005.008" => "A", "005.009" => "A", "005.010" => "A", "007.001" => "A", "007.002" => "A", "007.003" => "A", "007.004" => "A", "007.005" => "A", "007.006" => "B", "007.007" => "B", "007.008" => "B", "007.009" => "C", "007.010" => "C", "007.011" => "C", "007.012" => "C", "007.013" => "C", "007.014" => "C", "007.015" => "C", "007.016" => "D", "007.017" => "D", "007.018" => "E", "007.019" => "E", "007.020" => "F", "007.021" => "F", "007.022" => "F", "008.001" => "A", "008.002" => "A", "008.003" => "A", "008.004" => "A", "008.005" => "A", "008.006" => "A", "008.007" => "B", "008.008" => "B", "008.009" => "B", "008.010" => "B", "008.011" => "B", "008.012" => "B", "008.013" => "C", "008.014" => "C", "008.015" => "C", "008.016" => "C", "008.017" => "D", "008.018" => "D", "008.019" => "D", "008.020" => "D", "008.021" => "D", "008.022" => "D", "008.023" => "D", "008.024" => "D", "008.025" => "D", "008.026" => "D", "008.027" => "E", "008.028" => "E", "008.029" => "E", "008.030" => "E", "008.031" => "E", "008.032" => "E", "008.033" => "E", "008.034" => "E", "008.035" => "E", "008.036" => "E", "008.037" => "F", "008.038" => "F", "008.039" => "F", "008.040" => "F", "008.041" => "F", "008.042" => "F", "008.043" => "F", "008.044" => "F", "008.045" => "F", "008.046" => "F", "008.047" => "F", "008.048" => "F", "008.049" => "F", "008.050" => "F", "008.051" => "F", "008.052" => "F", "008.053" => "F", "008.054" => "F", "008.055" => "F", "008.056" => "F", "008.057" => "F", "008.058" => "G", "008.059" => "G", "008.060" => "G", "008.061" => "G", "008.062" => "G", "008.063" => "G", "008.064" => "G", "008.065" => "G", "008.066" => "G", "008.067" => "G", "008.068" => "G", "008.069" => "G", "008.070" => "G", "008.071" => "G", "009.001" => "A", "009.002" => "A", "009.003" => "A", "009.004" => "A", "010.001" => "A", "010.002" => "A", "010.003" => "A", "010.004" => "A", "010.005" => "A", "012.001" => "A", "012.002" => "A", "012.003" => "A", "012.004" => "A", "012.005" => "A", "012.006" => "A", "012.007" => "A", "012.008" => "A", "012.009" => "B", "012.010" => "B", "012.011" => "B", "012.012" => "B", "012.013" => "B", "012.014" => "C", "012.015" => "C", "012.016" => "C", "012.017" => "C", "012.018" => "C", "012.019" => "C", "012.020" => "C", "013.001" => "A", "013.002" => "A", "013.003" => "A", "013.004" => "A", "013.005" => "B", "013.006" => "B", "013.007" => "C", "013.008" => "C", "013.009" => "D", "013.010" => "D", "013.011" => "D", "013.012" => "D", "013.013" => "D", "013.014" => "D", "014.001" => "A", "014.002" => "A", "014.003" => "A", "014.004" => "A", "014.005" => "A", "014.006" => "B", "014.007" => "B", "014.008" => "B", "014.009" => "B", "014.010" => "C", "014.011" => "C", "014.012" => "C", "014.013" => "D", "014.014" => "D", "014.015" => "D", "014.016" => "D", "014.017" => "D", "014.018" => "D", "014.019" => "D", "014.020" => "D", "014.021" => "D", "014.022" => "E", "014.023" => "E", "014.024" => "E", "014.025" => "E", "014.026" => "E", "014.027" => "F", "014.028" => "F", "014.029" => "F", "014.030" => "F", "014.031" => "F", "014.032" => "F", "014.033" => "G", "015.001" => "A", "015.002" => "A", "015.003" => "A", "015.004" => "A", "015.005" => "B", "015.006" => "B", "015.007" => "B", "015.008" => "B", "015.009" => "B", "015.010" => "C", "015.011" => "C", "015.012" => "C", "015.013" => "D", "015.014" => "D", "015.015" => "D", "015.016" => "D", "015.017" => "D", "015.018" => "D", "015.019" => "D", "015.020" => "E", "015.021" => "E", "015.022" => "E", "016.004A" => "A", "016.004B" => "A", "016.001" => "A", "016.002" => "A", "016.003" => "A", "016.005" => "B", "016.006" => "B", "016.007" => "B", "016.008" => "B", "016.009" => "C", "016.010" => "C", "016.011" => "C", "016.012" => "C", "016.013" => "C", "016.014" => "D", "016.015" => "D", "016.016" => "D", "016.017" => "E", "016.018" => "E", "016.019" => "E", "016.020" => "E", "016.021" => "E", "017.001" => "A", "017.002" => "A", "017.003" => "A", "017.004" => "A", "017.005" => "A", "017.006" => "A", "017.007" => "B", "017.008" => "B", "017.009" => "B", "017.010" => "C", "017.011" => "C", "017.012" => "C", "017.013" => "C", "018.001" => "A", "018.002" => "A", "018.003" => "A", "018.004" => "B", "018.005" => "B", "018.006" => "B", "018.007" => "B", "018.008" => "B", "018.009" => "B", "018.010" => "B", "018.011" => "B", "018.012" => "B", "019.001" => "A", "019.002" => "A", "019.003" => "A"];
			$content['Box'] = $matches[1] . $lookup{$matches[1] . '.' . $matches[2]};
			$content['File'] = $matches[2];

			if(isset($data['AccessLevel'])) $data['AccessLevel'] = 0;

			$json = json_encode($content, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT);
			file_put_contents($jsonFile, $json);
		}
	}
}

?>
